@{
    ViewData["Title"] = "Student Attendance Search";
    Layout = "_Layout";
}
<style>
        /* Previous styles remain unchanged */
        :root {
            --sidebar-width: 0px !important;
        }
        </style>

<div class="attendance-search-page">
    <div class="header">
        <h3>Student Attendance System</h3>
        <a href="/Account/Login" class="login-btn">
            <i class="fas fa-sign-in-alt"></i> Login
        </a>
    </div>

    <div class="main-content">
        <div class="search-logo">
            <span>S</span><span>t</span><span>u</span><span>d</span><span>e</span><span>n</span><span>t</span>
        </div>

        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="studentSearch" class="search-box" placeholder="Search student by name..." autocomplete="off">
            <div id="studentDropdown" class="student-dropdown" style="display: none;"></div>
        </div>

        <div class="buttons-container">
            <button id="searchBtn" class="search-btn">Search Student</button>
        </div>

        <div id="attendanceResults" class="search-results" style="display: none;"></div>
    </div>

    <div class="footer">
        <div class="footer-content">
            <img src="~/Images/favicon.png" alt="Logo">
            <span class="footer-text">Student Attendance System</span>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            let selectedStudentId = null;
            
            // Handle student search with debounce
            let searchTimeout;
            $('#studentSearch').on('input', function() {
                clearTimeout(searchTimeout);
                const searchTerm = $(this).val().trim();
                
                if (searchTerm.length < 3) {
                    $('#studentDropdown').hide();
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    $.ajax({
                        url: '/Home/SearchStudents',
                        type: 'GET',
                        data: { searchTerm: searchTerm },
                        success: function(data) {
                            if (data && data.length > 0) {
                                let html = '';
                                data.forEach(function(student) {
                                    html += `<div class="student-item" data-id="${student.id}">
                                        <div class="student-name">${student.name}</div>
                                        <div class="student-class">${student.className}</div>
                                    </div>`;
                                });
                                $('#studentDropdown').html(html).show();
                            } else {
                                $('#studentDropdown').html('<div class="student-item">No students found</div>').show();
                            }
                        },
                        error: function() {
                            $('#studentDropdown').html('<div class="student-item">Error searching students</div>').show();
                        }
                    });
                }, 300);
            });
            
            // Handle student selection
            $(document).on('click', '.student-item', function() {
                const id = $(this).data('id');
                if (!id) return;
                
                selectedStudentId = id;
                const name = $(this).find('.student-name').text();
                $('#studentSearch').val(name);
                $('#studentDropdown').hide();
            });
            
            // Handle search button click
            $('#searchBtn').on('click', function() {
                if (!selectedStudentId) {
                    alert('Please select a student from the dropdown');
                    return;
                }
                
                $.ajax({
                    url: '/Home/GetStudentAttendance',
                    type: 'GET',
                    data: { studentId: selectedStudentId },
                    success: function(data) {
                        if (data.success) {
                            // Format the attendance data
                            let html = `
                                <div class="student-info">
                                    <h3>${data.studentName}</h3>
                                    <p>Class: ${data.className}</p>
                                </div>
                                <div class="attendance-stats">
                                    <h4>Overall Attendance: ${data.overallAttendance.toFixed(1)}%</h4>
                                    <p>Attended ${data.attendedClasses} out of ${data.totalClasses} classes</p>
                                    <div class="progress">
                                        <div class="progress-bar ${data.overallAttendance < 75 ? 'bg-danger' : 'bg-success'}" 
                                            role="progressbar" 
                                            style="width: ${data.overallAttendance}%" 
                                            aria-valuenow="${data.overallAttendance}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100"></div>
                                    </div>
                                    
                                    <div class="subject-attendance">
                                        <h5>Subject-wise Attendance</h5>
                                        ${data.subjectAttendance.map(subject => `
                                            <div class="subject-row">
                                                <div class="subject-name">${subject.subjectName}</div>
                                                                                                <div class="subject-stats">
                                                    <span class="badge ${subject.present/subject.total*100 < 75 ? 'bg-danger' : 'bg-success'}">
                                                        ${subject.present}/${subject.total} (${(subject.present/subject.total*100).toFixed(1)}%)
                                                    </span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                            $('#attendanceResults').html(html).show();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    },
                    error: function() {
                        alert('Error retrieving attendance data');
                    }
                });
            });
            
            // Close dropdown when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.search-container').length) {
                    $('#studentDropdown').hide();
                }
            });
            
            // Handle Enter key press
            $('#studentSearch').on('keypress', function(e) {
                if (e.which === 13 && selectedStudentId) {
                    $('#searchBtn').click();
                }
            });
        });
    </script>
}