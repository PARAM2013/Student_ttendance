@model TopicDiscussionsReportViewModel
@{
    ViewData["Title"] = "Topic Discussions Report";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-comments me-2"></i>Topic Discussions Report
            </h3>
        </div>
        <div class="card-body">
            <form id="reportForm" class="mb-4">
                <div class="row g-3">
                    @if (User.IsInRole("Admin"))
                    {
                        <div class="col-md-3">
                            <label class="form-label">Teacher</label>
                            <select asp-for="TeacherId" asp-items="Model.Teachers" class="form-select" required>
                                <option value="">Select Teacher</option>
                            </select>
                        </div>
                    }
                    else
                    {
                        <input type="hidden" asp-for="TeacherId" />
                    }
                    
                    <div class="col-md-3">
                        <label class="form-label">Subject</label>
                        <select asp-for="SubjectId" asp-items="Model.Subjects" class="form-select" required>
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">Start Date</label>
                        <input type="date" asp-for="StartDate" class="form-control" required />
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">End Date</label>
                        <input type="date" asp-for="EndDate" class="form-control" required />
                    </div>
                    
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-search me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </form>

            <div id="reportContent">
                <!-- Report content will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // For admin: Update subjects when teacher changes
            $('#TeacherId').change(function() {
                var teacherId = $(this).val();
                if (teacherId) {
                    $.get('/Attendance/GetTeacherSubjects', { teacherId: teacherId })
                        .done(function(response) {
                            var options = '<option value="">Select Subject</option>';
                            response.forEach(function(subj) {
                                options += `<option value="${subj.id}">${subj.name}</option>`;
                            });
                            $('#SubjectId').html(options);
                        })
                        .fail(function() {
                            showAlert('Error', 'Failed to load subjects', 'error');
                        });
                }
            });
        });

        function generateReport() {
            var form = $('#reportForm');
            var teacherId = $('#TeacherId').val();
            var subjectId = $('#SubjectId').val();
            var startDate = $('#StartDate').val();
            var endDate = $('#EndDate').val();

            if (!subjectId || !startDate || !endDate) {
                showAlert('Warning', 'Please fill all required fields', 'warning');
                return;
            }

            $('#reportContent').html('<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Generating report...</div>');

            $.get('/Attendance/GetTopicDiscussionsReport', {
                teacherId: teacherId,
                subjectId: subjectId,
                startDate: startDate,
                endDate: endDate
            })
            .done(function(response) {
                $('#reportContent').html(response);
            })
            .fail(function() {
                showAlert('Error', 'Failed to generate report', 'error');
                $('#reportContent').html('');
            });
        }
    </script>
}
